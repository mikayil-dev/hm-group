---
interface Props {
  id?: string | undefined;
  heading: string;
  video: string;
}

const { id = 'video', heading, video }: Props = Astro.props;

const getVideoType = (src: string): string => {
  if (src.endsWith('.webm')) return 'video/webm';
  if (src.endsWith('.mp4')) return 'video/mp4';
  return 'video/mp4';
};

const videoType = getVideoType(video);
---

<section id={id} class="video-section">
  <h2 class="section-heading animate right">{heading}</h2>

  <div class="video-container animate bottom">
    <video
      controls
      preload="metadata"
      playsinline
      data-src={video}
      data-type={videoType}
      class="lazy-video"
    >
      <source data-src={video} data-type={videoType} />
      Ihr Browser unterst√ºtzt keine Videos.
    </video>
  </div>
</section>

<script>
  function initLazyVideos() {
    const videos = document.querySelectorAll<HTMLVideoElement>('.lazy-video');

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const video = entry.target as HTMLVideoElement;
            const src = video.dataset.src;

            if (src) {
              video.src = src + '#t=0.1';
              const source = video.querySelector('source');
              if (source) {
                if (source.dataset.src) source.src = source.dataset.src;
                if (source.dataset.type) source.type = source.dataset.type;
              }
              video.load();
            }

            observer.unobserve(video);
          }
        });
      },
      { rootMargin: '200px' },
    );

    videos.forEach((video) => observer.observe(video));
  }

  initLazyVideos();

  document.addEventListener('astro:after-swap', initLazyVideos);
</script>

<style lang="scss">
  .video-section {
    .video-container {
      display: flex;
      justify-content: center;
    }

    video {
      width: fit-content;
      max-width: 100%;
      max-width: 800px;
      max-height: 80svh;
      max-height: 80vh;
      border-radius: 2px;
      border: 2px solid var(--secondary);
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.4);
      background-color: var(--darkgray);
    }
  }
</style>
