---
import { parseMarkdown } from '@lib/markdown';

interface Attribution {
  text?: string | undefined;
  url?: string | undefined;
}

interface Props {
  id?: string | undefined;
  heading: string;
  text: string;
  media: string;
  mediaAlt?: string | undefined;
  mediaPosition?: 'left' | 'right' | undefined;
  attribution?: Attribution | undefined;
}

const {
  id = 'ueber',
  heading,
  text,
  media,
  mediaAlt = '',
  mediaPosition = 'right',
  attribution,
}: Props = Astro.props;

const htmlText = parseMarkdown(text);

const videoExtensions = ['.mp4', '.webm'];
const isVideo = videoExtensions.some((ext) =>
  media.toLowerCase().endsWith(ext),
);

const getVideoType = (src: string): string => {
  if (src.endsWith('.webm')) return 'video/webm';
  return 'video/mp4';
};

const videoType = isVideo ? getVideoType(media) : undefined;
---

<section id={id} class:list={['text-img', mediaPosition === 'left' && 'left']}>
  <h2 class="section-heading animate right">{heading}</h2>

  <div class="content">
    <div class="text-container animate left">
      <div set:html={htmlText} class="text-content" />
    </div>

    <div class="media-container animate right">
      {
        isVideo ? (
          <video
            controls
            preload="metadata"
            playsinline
            data-src={media}
            data-type={videoType}
            class="lazy-video"
          >
            <source data-src={media} data-type={videoType} />
            Ihr Browser unterst√ºtzt keine Videos.
          </video>
        ) : (
          <>
            <img src={media} alt={mediaAlt} loading="lazy" decoding="async" />
            {attribution?.text && (
              <a
                href={attribution.url || '#'}
                class="attribution"
                target={attribution.url ? '_blank' : undefined}
                rel={attribution.url ? 'noopener' : undefined}
              >
                {attribution.text}
              </a>
            )}
          </>
        )
      }
    </div>
  </div>
</section>

<script>
  function initLazyVideos() {
    const videos = document.querySelectorAll<HTMLVideoElement>('.lazy-video');
    if (!videos.length) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const video = entry.target as HTMLVideoElement;
            const src = video.dataset.src;

            if (src) {
              video.src = src + '#t=0.1';
              const source = video.querySelector('source');
              if (source) {
                if (source.dataset.src) source.src = source.dataset.src;
                if (source.dataset.type) source.type = source.dataset.type;
              }
              video.load();
            }

            observer.unobserve(video);
          }
        });
      },
      { rootMargin: '200px' },
    );

    videos.forEach((video) => observer.observe(video));
  }

  initLazyVideos();

  document.addEventListener('astro:after-swap', initLazyVideos);
</script>

<style lang="scss">
  .text-img {
    &.left {
      .content {
        .text-container {
          order: 2;
        }

        .media-container {
          order: 1;
        }
      }
    }

    .content {
      display: flex;
      gap: 100px;

      @include view-tablet-l {
        flex-direction: column;
        gap: 40px;
      }

      .text-container {
        flex: 1 1 400px;

        .text-content {
          width: 100%;
          @include copy;
        }
      }

      &:has(.media-container > img) {
        .text-container {
          flex: 1;
        }
      }

      .media-container {
        align-self: start;
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 2px;
        position: relative;
        overflow: hidden;
        border: 2px solid var(--secondary);
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.4);

        &:has(> video) {
          margin: 0 auto;
          max-width: 100%;
          width: fit-content;
          flex: 0 1 auto;
        }

        &:has(> img) {
          flex: 1;
        }

        img {
          width: 100%;
          height: 100%;
          object-fit: contain;
          object-position: top;
        }

        video {
          max-width: 100%;
          width: fit-content;
          max-height: 80svh;
          max-height: 80vh;
          background-color: var(--darkgray);
        }

        .attribution {
          position: absolute;
          bottom: 0;
          right: 0;
          padding: 8px;
          background-color: rgba(0, 0, 0, 0.5);
          color: var(--text);
          font-size: 0.75rem;
          text-decoration: none;
          transition: all 0.2s ease-in-out;

          @include hover {
            color: var(--accent);
          }
        }
      }
    }
  }
</style>
